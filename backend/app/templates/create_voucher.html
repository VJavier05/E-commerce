{% extends "dashboard_2.html" %}
{% block content %}
<h2 class="mb-4">Create Shop Voucher</h2>
<div class="d-flex justify-content-between align-items-center py-3 mb-2">
    <h4 class="fw-bold mb-0">
    </h4>
    <a href="{{ url_for('view_table_vouchers') }}" class="btn btn-primary">
        <i class="bi bi-table pe-md-2 pe-1"></i> View My Vouchers
    </a>
</div>

<!-- Flash Messages Section -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} d-flex align-items-center mx-auto">
                {{ message }}
                <button type="button" class="btn-close ms-3" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}


    <!-- Create Voucher Form Container -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Voucher Details</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('create_voucher') }}">
                <div class="row mb-3">  
                    <div class="col-md-6"> 
                        <label for="display_voucher_type" class="form-label">Selected Voucher Type</label>
                        <input type="text" id="display_voucher_type" class="form-control" value="Shop Voucher" readonly>
                    </div>
                </div>
                <!-- Voucher Name and Code -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="voucher_name" class="form-label">Voucher Name</label>
                        <input type="text" name="voucher_name" id="voucher_name" class="form-control" placeholder="Enter Voucher Name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="voucher_code" class="form-label">Voucher Code (optional)</label>
                        <input type="text" name="code" id="voucher_code" class="form-control" placeholder="Auto-generated if left blank">
                    </div>
                </div>

                <!-- Start and Expiration Dates -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" name="start_date" id="start_date" class="form-control restrict-input" required>
                    </div>
                    <div class="col-md-6">
                        <label for="expiration_date" class="form-label">Expiration Date</label>
                        <input type="date" name="expiration_date" id="expiration_date" class="form-control restrict-input" required>
                    </div>
                </div>

                <!-- Checkbox for Early Display -->
                <div class="form-check mb-3">
                    <input type="checkbox" name="display_early" id="displayEarlyCheckbox" class="form-check-input" aria-label="Display Early">
                    <label for="displayEarlyCheckbox" class="form-check-label">Display Early</label>
                </div>

                <!-- Early Display Fields -->
                <div id="earlyDisplayFields" style="display: none; width: 50%;">
                    <label for="early_usage_period_start" class="form-label">Usage Period Start</label>
                    <input type="datetime-local" name="early_usage_period_start" id="early_usage_period_start" class="form-control" required>
                    <small class="form-text text-muted">Once the voucher starts displaying, this section can no longer be edited.</small>
                </div>
        </div>
    </div>

    <!-- Reward Type Container -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Reward Type</h5>
        </div>
        <div class="card-body">
            <!-- Discount Type and Amount -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="discount_type" class="form-label">Discount Type</label>
                    <select id="discount_type" name="discount_type" class="form-select" required onchange="updateDiscountIcon()">
                        <option value="percentage">Percentage Off</option>
                        <option value="value">Fixed Amount</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="discount_amount" class="form-label">Discount Amount</label>
                    <div class="input-group">
                        <span class="input-group-text" id="discount_icon">%</span>
                        <input type="number" name="discount_amount" id="discount_amount" class="discount-amount form-control restrict-input" placeholder="Enter Discount Amount" step="0.01" required>
                    </div>
                </div>
            </div>

            <!-- Minimum Basket Price and Quantity -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="min_price" class="form-label">Minimum Basket Price</label>
                    <div class="input-group">
                        <span class="input-group-text">₱</span>
                        <input type="number" name="min_price" id="min_price" class="min-price form-control restrict-input" placeholder="Enter Minimum Price" step="0.01" required>
                    </div>
                </div>       
                <div class="col-md-6">
                    <label for="quantity" class="form-label">Usage Quantity</label>
                    <input type="number" name="quantity" id="quantity" class="form-control restrict-input" placeholder="Enter Usage Limit" required>
                </div> 
            </div>
        </div>
    </div>

    <!-- Voucher Display & Application Products Container -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Voucher Display & Application Products</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="voucherDisplay" class="mb-2">Voucher Display Setting</label>
                <div class="form-check mb-2">
                    <input type="radio" id="displayAllPages" name="voucherDisplay" value="allPages" class="form-check-input">
                    <label for="displayAllPages" class="form-check-label">Display on All Pages</label>
                </div>
                <div class="form-check mb-2">
                    <input type="radio" id="shareThroughCode" name="voucherDisplay" value="shareCode" class="form-check-input">
                    <label for="shareThroughCode" class="form-check-label">To be Shared Through Voucher Code</label>
                </div>
            </div>
            <!-- Submission Button -->
            <div class="d-flex justify-content-end mt-4">
                <a href="{{ url_for('view_vouchers') }}" class="btn btn-secondary me-2">Cancel</a>
                <button type="submit" class="btn btn-primary">Create Voucher</button>
            </div>
       </div>
    </div>


  
</form>


<script>
    function updateDiscountIcon() {
        const discountType = document.getElementById('discount_type').value;
        const discountIcon = document.getElementById('discount_icon');
        discountIcon.textContent = discountType === 'percentage' ? '%' : '₱';
    }

    // JavaScript to handle the Display Early logic
    document.getElementById('displayEarlyCheckbox').addEventListener('change', function() {
        document.getElementById('earlyDisplayFields').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('start_date').addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        // Set time to 12:00 AM
        selectedDate.setHours(0, 0, 0, 0);
        document.getElementById('early_usage_period_start').value = selectedDate.toISOString().slice(0, 16);
    });

    document.querySelectorAll('.restrict-input').forEach(function(input) {
        input.addEventListener('input', function(event) {
            if (this.type === 'number') {
                // Remove any non-numeric characters except dot for decimal numbers
                this.value = this.value.replace(/[^0-9.]/g, '');
                
                // Prevent negative numbers
                if (parseFloat(this.value) < 0) {
                    this.value = '';
                }
            }
        });
    });

    document.getElementById("discount_amount").addEventListener("input", function() {
        let discountType = document.getElementById("discount_type").value;
        let discountValue = parseFloat(this.value);
        
        // Ensure percentage discount cannot exceed 100
        if (discountType === "percentage" && discountValue > 100) {
            alert("Percentage discount cannot exceed 100.");
            this.value = 100;
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const displayEarlyCheckbox = document.getElementById('displayEarlyCheckbox');
        const earlyDisplayFields = document.getElementById('earlyDisplayFields');
        const usagePeriodStartInput = document.getElementById('start_date');
        const earlyUsagePeriodStartInput = document.getElementById('early_usage_period_start');

        displayEarlyCheckbox.addEventListener('change', function () {
            if (this.checked) {
                // Display the early usage period fields
                earlyDisplayFields.style.display = 'block';
                // Set the early usage period start to match the start date (with time set to midnight)
                const selectedDate = new Date(usagePeriodStartInput.value);
                selectedDate.setHours(0, 0, 0, 0);
                earlyUsagePeriodStartInput.value = selectedDate.toISOString().slice(0, 16);
            } else {
                // Hide the early usage period fields and clear the input
                earlyDisplayFields.style.display = 'none';
                earlyUsagePeriodStartInput.value = '';
            }
        });

        usagePeriodStartInput.addEventListener('change', function () {
            if (displayEarlyCheckbox.checked) {
                // When start date changes and Display Early is checked, update the early usage period start
                const selectedDate = new Date(this.value);
                selectedDate.setHours(0, 0, 0, 0);
                earlyUsagePeriodStartInput.value = selectedDate.toISOString().slice(0, 16);
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const startDateInput = document.getElementById('start_date');
        const expirationDateInput = document.getElementById('expiration_date');

        startDateInput.addEventListener('change', function () {
            const startDate = new Date(this.value);
            if (startDate) {
                // Set the minimum expiration date to one day after the start date
                let minExpirationDate = new Date(startDate);
                minExpirationDate.setDate(minExpirationDate.getDate() + 1);
                expirationDateInput.min = minExpirationDate.toISOString().split("T")[0];
            }
        });

        expirationDateInput.addEventListener('input', function () {
            const startDate = new Date(startDateInput.value);
            const expirationDate = new Date(this.value);

            if (expirationDate <= startDate) {
                alert("Expiration date must be after the start date.");
                this.value = ''; // Clear invalid date
            }
        });
    });

    function validateVoucherDisplaySelection() {
        const displayOptions = document.querySelectorAll('input[name="voucherDisplay"]');
        let selected = false;

        displayOptions.forEach(option => {
            if (option.checked) {
                selected = true;
            }
        });

        if (!selected) {
            alert("Please select a Voucher Display Setting.");
            return false;
        }

        return true;
    }

</script>
{% endblock %}
