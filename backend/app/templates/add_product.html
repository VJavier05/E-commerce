{% extends "dashboard_2.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center py-3 mb-2">
    <h4 class="fw-bold mb-0">
        <span class="text-muted fw-light">Products /</span> Add Products
    </h4>

    
</div>

<div class="row">
    <div class="col-xl-12">
        <div class="nav-align-top mb-4">


              <div class="card mb-4">
                <h5 class="card-header">Basic Information</h5>
                <form method="POST" action="{{ url_for('add_product') }}" enctype="multipart/form-data" novalidate onsubmit="return validateForm()">
                    {{ form.hidden_tag() }}

                <div class="card-body">
                    <div class="row">
                        <div class="mb-3 col-md-6">
                            <!-- <label for="productName" class="form-label">Product Name</label>
                            {{ form.product_name(class="form-control", id="productName") }} -->
    
                            {% if form.product_name.errors %}
                            <label for="productName" class="form-label">Product Name</label>
    
                            {{ form.product_name(class="form-control is-invalid", id="productName", placeholder="Enter Product") }}
                            <div class="invalid-feedback">
                                {% for error in form.product_name.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <label for="productName" class="form-label">Product Name</label>
    
                                {{ form.product_name(class="form-control", id="productName", placeholder="Enter Product") }}
                            {% endif %}
    
                        </div>
                        <div class="mb-3 col-md-6">
                            {% if form.category.errors %}
                            <label for="productCategory" class="form-label">Category</label>
                            {{ form.category(class="form-select is-invalid", id="productCategory") }}
                            <div class="invalid-feedback">
                                {% for error in form.category.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                                <label for="productCategory" class="form-label">Category</label>
                                {{ form.category(class="form-select", id="productCategory") }}
                            {% endif %}
                        </div>

                        
                        <div class="mb-3 col-md-6">
                            {% if form.brand.errors %}
                            <label for="productBrand" class="form-label">Enter Brand</label>
    
                            {{ form.brand(class="form-control is-invalid", id="productBrand", placeholder="Enter Brand") }}
                            <div class="invalid-feedback">
                                {% for error in form.brand.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <label for="productBrand" class="form-label">Product Brand</label>
    
                                {{ form.brand(class="form-control", id="productBrand", placeholder="Enter Brand") }}
                            {% endif %}
    
                        </div>


                        <div class="mb-3 col-md-6">
                            {% if form.material.errors %}
                            <label for="productMaterial" class="form-label">Enter Material</label>
    
                            {{ form.material(class="form-control is-invalid", id="productMaterial", placeholder="Enter Material") }}
                            <div class="invalid-feedback">
                                {% for error in form.material.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <label for="productMaterial" class="form-label">Product Material</label>
    
                                {{ form.material(class="form-control", id="productMaterial", placeholder="Enter Material") }}
                            {% endif %}
    
                        </div>
     
            
          
                        <div class="mb-3 col-md-12">
                            {% if form.description.errors %}
                                    <label for="productDescription" class="form-label">Product Description</label>
                                    {{ form.description(class="form-control is-invalid", id="productDescription", rows="3") }}
                                    <div class="invalid-feedback">
                                        {% for error in form.description.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <label for="productDescription" class="form-label">Product Description</label>
                                    {{ form.description(class="form-control", id="productDescription", rows="3") }}
                                {% endif %}
                        </div>

                        <div class="mb-3 col-md-12">
                            {{ form.product_images.label(class="form-label") }}
                            {{ form.product_images(class="form-control", id="product-images-input") }} 
                            <small class="form-text text-muted">Upload product images (jpg, png). Maximum/Minumum: 4 images.</small>
                        </div>
             
                        <div id="image-preview" class="mt-3" style="display: flex; flex-wrap: wrap;">
                        </div>
                    </div>
                </div>

              </div>



              <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center py-3 mb-2">
                    <h5 class="card-header">Variations</h5>
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-plus-lg pe-md-2 pe-1"></i>Add Variation
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="addColorVariation()">Add Color</a></li>
                    </ul>
                </div>
            
                <div class="card-body" id="color-variations-container"></div>
            </div>
            
            <table class="table" id="variations-table">
                <thead class="table-dark">
                    <tr>
                        <th>Color</th>
                        <th>Sizes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <input type="hidden" id="variations-data" name="variations_data">

            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
        </div>
    </div>
</div>



<script>
    function validateForm() {
        // Get all form fields
        const formFields = [
            { element: document.getElementById('productName'), errors: [] },
            { element: document.getElementById('productCategory'), errors: [] },
            { element: document.getElementById('productBrand'), errors: [] },
            { element: document.getElementById('productMaterial'), errors: [] },
            { element: document.getElementById('productDescription'), errors: [] },
        ];

        let isValid = true;

        // Validate each field
        formFields.forEach(field => {
            if (!field.element.value.trim()) {
                field.errors.push('This field is required.');
                field.element.classList.add('is-invalid');
                isValid = false;
            } else {
                field.element.classList.remove('is-invalid');
                field.element.classList.add('is-valid');
            }
        });

        return isValid;
    }


    



let colorCount = 0;

function addColorVariation() {
    const colorContainer = document.getElementById('color-variations-container');
    const colorVariationDiv = document.createElement('div');
    colorVariationDiv.className = 'mb-3 border p-3 rounded';
    colorVariationDiv.id = `color-variation-${colorCount}`;

    // Hidden input to track the color count
    const colorCountInput = document.createElement('input');
    colorCountInput.type = 'hidden';
    colorCountInput.name = `color_count`;
    colorCountInput.value = colorCount + 1;
    colorContainer.appendChild(colorCountInput);

    colorVariationDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4 mb-2">
                <label for="color-${colorCount}" class="form-label">Color</label>
                <input type="text" class="form-control" id="color-${colorCount}" name="color-${colorCount}" placeholder="Enter color" oninput="updateTable()">
            </div>
            <div class="col-md-6 mb-2" id="sizes-container-${colorCount}">
                <label for="size-${colorCount}" class="form-label">Sizes</label>
                <select class="form-select mb-2" id="size-${colorCount}" name="size-${colorCount}" onchange="addSizeFromDropdown(event, ${colorCount})">
                    <option value="" disabled selected>Select size</option>
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                    <option value="XXL">XXL</option>
                    <!-- Add more sizes as needed -->
                </select>
            </div>
        </div>
    `;

    colorContainer.appendChild(colorVariationDiv);
    colorCount++;
}

function addSizeFromDropdown(event, colorIndex) {
    const sizeSelect = event.target;
    const size = sizeSelect.value;

    if (size) {
        const sizesContainer = document.getElementById(`sizes-container-${colorIndex}`);

        const sizeDiv = document.createElement('div');
        sizeDiv.className = 'input-group mb-2';
        sizeDiv.innerHTML = `
            <input type="text" class="form-control" value="${size}" readonly>
            <input type="number" class="form-control" placeholder="Stock" min="1" oninput="updateTable()">
            <input type="number" class="form-control" placeholder="Price" step="0.01" min="0" oninput="updateTable()">
            <button class="btn btn-outline-danger" type="button" onclick="removeSize(this)">Remove</button>
        `;

        sizesContainer.appendChild(sizeDiv);
        sizeSelect.value = ''; // Reset the dropdown
        updateTable();
    }
}

function removeColorVariation(colorIndex) {
    const colorVariationDiv = document.getElementById(`color-variation-${colorIndex}`);
    colorVariationDiv.remove();
    updateTable();
}

function removeSize(sizeElement) {
    sizeElement.parentElement.remove();
    updateTable();
}

function updateTable() {
    const tableBody = document.querySelector('#variations-table tbody');
    tableBody.innerHTML = '';

    const variations = []; // Array to hold variations

    for (let i = 0; i < colorCount; i++) {
        const colorInput = document.getElementById(`color-${i}`);
        const sizesContainer = document.getElementById(`sizes-container-${i}`);

        if (colorInput && sizesContainer) {
            const color = colorInput.value.trim();
            const sizeRows = sizesContainer.getElementsByClassName('input-group');

            if (color && sizeRows.length > 0) {
                const sizes = [];

                Array.from(sizeRows).forEach(row => {
                    const size = row.querySelector('input[type="text"]').value;
                    const stock = row.querySelector('input[type="number"]').value || '0';
                    const price = row.querySelectorAll('input[type="number"]')[1].value || '0.00';
                    
                    sizes.push({
                        size: size,
                        stock: stock,
                        price: price
                    });
                });

                variations.push({
                    color: color,
                    sizes: sizes
                });

                const newRow = `
                    <tr>
                        <td>${color}</td>
                        <td>${sizes.map(s => `${s.size} (Stock: ${s.stock}, Price: â‚±${s.price})`).join(', ')}</td>
                    </tr>
                `;
                tableBody.innerHTML += newRow;
            }
        }
    }

    
    // Store variations in a hidden input field for submission
    document.getElementById('variations-data').value = JSON.stringify(variations);

    
}
</script>
  
  

{% endblock %}
