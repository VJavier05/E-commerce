{% extends "dashboard_1.html" %}
{% block content %}

<h4 class="fw-bold py-3 mb-2"><span class="text-muted fw-light">Accounts/</span> Manage Users</h4>



<div class="row"></div>
  <div class="col-xl-12">
    <div class="nav-align-top mb-4">
      <ul class="nav nav-pills mb-3" role="tablist">
        <li class="nav-item">
            <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab" 
                    data-bs-target="#navs-pills-user" id="manage-user-tab" aria-controls="navs-pills-user" aria-selected="true">
                Manage Users
            </button>
        </li>
        <li class="nav-item">
            <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                    data-bs-target="#navs-pills-seller" id="manage-seller-tab" aria-controls="navs-pills-seller" aria-selected="false">
                Manage Sellers
            </button>
        </li>
        <li class="nav-item">
            <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                    data-bs-target="#navs-pills-archive" id="ban-user-tab" aria-controls="navs-pills-archive" aria-selected="false">
                Banned Users
            </button>
        </li>
        <li class="nav-item">
            <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                    data-bs-target="#navs-pills-archive-seller" id="ban-seller-tab" aria-controls="navs-pills-archive-seller" aria-selected="false">
                Banned Sellers
            </button>
        </li>
    </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="navs-pills-user" role="tabpanel">
          
          <div class="input-group input-group-merge mb-3  search-input">
            <span class="input-group-text "><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              placeholder="Search..."
              aria-label="Search..."
              id="searchManageUser"  
              onkeyup="searchTable('manageUsertable', 'searchManageUser')"  
            />
        </div>

        
          <table class="table align-middle mb-0" id="manageUsertable">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Created</th>
                <th>Birthday</th>
                <th>Gender</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <th scope="row">{{ loop.index }}</th>  
          
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      src="{{ url_for('static', filename='profile_pics/' ~ user.image_file) }}"  
                      alt="User Image"
                      style="width: 45px; height: 45px"
                      class="rounded-circle"
                    />
                    <div class="ms-3">
                      <p class="fw-bold mb-1">{{ user.first_name }} {{ user.last_name }}</p>
                      <p class="text-muted mb-0">{{ user.email }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <p class="fw-normal mb-1">
                    {{ user.created_at.strftime('%B %d, %Y %I:%M %p') }}
            
                  </p>
                </td>
                <td>
                  <!-- <p class="fw-normal mb-1">{{ user.date_of_birth }}</p> -->
          
                  {% if user.date_of_birth %}
                    <p class="fw-normal mb-1">{{ user.date_of_birth.strftime('%B %d, %Y') }}</p>
                  {% else %}
                  <p class="fw-normal mb-1">None</p>
          
                  {% endif %}
          
                </td>
                <td>
                  <p class="fw-normal mb-1">{{ user.gender }}</p>
                </td>
                <td>


                  <button 
                  type="button" 
                  class="btn btn-danger btn-sm" 
                  data-bs-toggle="modal" 
                  data-bs-target="#banConfirmationModal"
                  data-user-id="{{ user.id }}"
                  data-user-name="{{ user.first_name }} {{ user.last_name }}">
                  Ban
                </button>
                    
                 
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          
          <div class="modal fade" id="ViewAccount" tabindex="-1" aria-labelledby="ViewAccount" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">User Information</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <img src="" id="modal-image" class="modal-image" alt="User Image" />
                      <div class="row mt-2">
                      <div class="col">
                        <label for="fname" class="form-label">First Name</label>
                        <input type="text" class="form-control" placeholder="First name" id="fname" aria-label="First name" readonly>
                      </div>
                      <div class="col">
                        <label for="lname" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lname" placeholder="Last name" aria-label="Last name" readonly>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          
                    <form id="approve-form" method="post">
                      <button type="submit" class="btn btn-success">Approve</button>
                    </form>   
          
                   </div>
                </div>
              </div>
          </div>
        </div>


        <div class="tab-pane fade" id="navs-pills-seller" role="tabpanel">
          <div class="input-group input-group-merge mb-3  search-input">
            <span class="input-group-text "><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              placeholder="Search..."
              aria-label="Search..."
              id="searchManageSeller"  
              onkeyup="searchTable('manageSellertable', 'searchManageSeller')"  
            />
        </div>

        
          <table class="table align-middle mb-0" id="manageSellertable">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Shop</th>
                <th>Seller</th>
                <th>Created</th>
                <th>Gender</th>

                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for seller, user in sellers %}
              <tr>
                <th scope="row">{{ loop.index }}</th>
            
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      src="{{ url_for('static', filename='profile_pics/' ~ seller.image_file) }}"  
                      alt="User Image"
                      style="width: 45px; height: 45px"
                      class="rounded-circle"
                    />
                    <div class="ms-3">
                      <p class="fw-bold mb-1">{{ seller.shop_name }}</p>
                      <p class="text-muted mb-0">Category: {{ seller.category.replace('_', ' & ') }}</p>
                    </div>
                  </div>
                </td>
            
                <td>
          

                  <p class="fw-bold mb-1">{{ user.first_name }} {{ user.last_name }}</p>
                      <p class="text-muted mb-0">{{ user.email }}</p>
                </td>
            
                <td>
                  <p class="fw-normal mb-1">{{ user.created_at.strftime('%B %d, %Y %I:%M %p') }}</p>
                </td>

            
                <td>
                  <p class="fw-normal mb-1">{{ user.gender }}</p>
                </td>
            
                <td>

                  <button 
                  type="button" 
                  class="btn btn-danger btn-sm" 
                  data-bs-toggle="modal" 
                  data-bs-target="#banConfirmationModal"
                  data-user-id="{{ user.id }}"
                  data-user-name="{{ user.first_name }} {{ user.last_name }}">
                  Ban
                </button>                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>


        <div class="tab-pane fade" id="navs-pills-archive" role="tabpanel">
          <div class="input-group input-group-merge mb-3  search-input">
            <span class="input-group-text "><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              placeholder="Search..."
              aria-label="Search..."
              id="searchInput"  
              onkeyup="searchTable()"  
            />
        </div>

        
          <table class="table align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Created</th>
                <th>Birthday</th>
                <th>Gender</th>
                <th>Ban Reason</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in banned_users %}
              <tr>
                <th scope="row">{{ loop.index }}</th>  
          
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      src="{{ url_for('static', filename='profile_pics/' ~ user.image_file) }}"  
                      alt="User Image"
                      style="width: 45px; height: 45px"
                      class="rounded-circle"
                    />
                    <div class="ms-3">
                      <p class="fw-bold mb-1">{{ user.first_name }} {{ user.last_name }}</p>
                      <p class="text-muted mb-0">{{ user.email }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <p class="fw-normal mb-1">
                    {{ user.created_at.strftime('%B %d, %Y %I:%M %p') }}
            
                  </p>
                </td>
                <td>
                  <!-- <p class="fw-normal mb-1">{{ user.date_of_birth }}</p> -->
          
                  {% if user.date_of_birth %}
                    <p class="fw-normal mb-1">{{ user.date_of_birth.strftime('%B %d, %Y') }}</p>
                  {% else %}
                  <p class="fw-normal mb-1">None</p>
          
                  {% endif %}
          
                </td>
                <td>
                  <p class="fw-normal mb-1">{{ user.gender }}</p>
                </td>

                <td>
                  <span class="badge rounded-pill text-bg-danger">{{ user.ban_reason if user.ban_reason else 'None' }}</span>
                </td>
                <td>
                  <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#unbanConfirmationModal"
                  data-user-name="{{ user.first_name }} {{ user.last_name }}" data-user-id="{{ user.id }}">
                    Unban
                  </button>      
                   </td>

              
              </tr>
              {% endfor %}
            </tbody>
          </table>
         
        </div>

        <div class="tab-pane fade" id="navs-pills-archive-seller" role="tabpanel">
          <div class="input-group input-group-merge mb-3  search-input">
            <span class="input-group-text "><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              placeholder="Search..."
              aria-label="Search..."
              id="searchManageSeller"  
              onkeyup="searchTable('manageSellertable', 'searchManageSeller')"  
            />
        </div>

        
          <table class="table align-middle mb-0" id="manageSellertable">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Shop</th>
                <th>Seller</th>
                <th>Created</th>
                <th>Gender</th>

                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for seller, user in ban_seller %}
              <tr>
                <th scope="row">{{ loop.index }}</th>
            
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      src="{{ url_for('static', filename='profile_pics/' ~ seller.image_file) }}"  
                      alt="User Image"
                      style="width: 45px; height: 45px"
                      class="rounded-circle"
                    />
                    <div class="ms-3">
                      <p class="fw-bold mb-1">{{ seller.shop_name }}</p>
                      <p class="text-muted mb-0">Category: {{ seller.category.replace('_', ' & ') }}</p>
                    </div>
                  </div>
                </td>
            
                <td>
          

                  <p class="fw-bold mb-1">{{ user.first_name }} {{ user.last_name }}</p>
                      <p class="text-muted mb-0">{{ user.email }}</p>
                </td>
            
                <td>
                  <p class="fw-normal mb-1">{{ user.created_at.strftime('%B %d, %Y %I:%M %p') }}</p>
                </td>

            
                <td>
                  <p class="fw-normal mb-1">{{ user.gender }}</p>
                </td>
            
                <td>

                  <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#unbanConfirmationModal"
                  data-user-name="{{ user.first_name }} {{ user.last_name }}" data-user-id="{{ user.id }}">
                    Unban
                  </button>  
                               </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
   

      </div>
    </div>
  </div>

</div>



<!-- Ban Confirmation Modal -->
<div class="modal fade" id="banConfirmationModal" tabindex="-1" aria-labelledby="banConfirmationLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="banConfirmationLabel">Ban User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to ban <strong id="banUserName"></strong>?</p>
        <form id="banUserForm" method="POST" action="">
          <div class="mb-3">
            <label for="banReason" class="form-label">Reason for Ban (optional)</label>
            <textarea class="form-control" id="banReason" name="ban_reason" rows="3"></textarea>
          </div>
          <input type="hidden" id="banUserId" name="user_id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger" form="banUserForm">Ban User</button>
      </div>
    </div>
  </div>
</div>


<!-- Unban Confirmation Modal -->
<div class="modal fade" id="unbanConfirmationModal" tabindex="-1" aria-labelledby="unbanConfirmationLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unbanConfirmationLabel">Unban User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to unban <strong id="unbanUserName"></strong>?</p>
        <form id="unbanUserForm" method="POST" action="">
          <input type="hidden" id="unbanUserId" name="user_id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger" form="unbanUserForm">Unban User</button>
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function () {
      // Save the active tab in localStorage when it's shown
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
          tab.addEventListener('shown.bs.tab', function (e) {
              const activeTab = e.target.getAttribute('data-bs-target');
              localStorage.setItem('activeTab', activeTab);
          });
      });

      // Get the active tab from localStorage
      const activeTab = localStorage.getItem('activeTab');
      if (activeTab) {
          const tabToActivate = document.querySelector(`[data-bs-target="${activeTab}"]`);
          if (tabToActivate) {
              const bootstrapTab = new bootstrap.Tab(tabToActivate); // Bootstrap's Tab instance
              bootstrapTab.show();
          }
      } else {
          // Default to the first tab if no activeTab is stored
          const firstTab = document.querySelector('[data-bs-toggle="tab"]');
          if (firstTab) {
              const bootstrapTab = new bootstrap.Tab(firstTab);
              bootstrapTab.show();
          }
      }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const banModal = document.getElementById('banConfirmationModal');
    const banUserName = document.getElementById('banUserName');
    const banUserId = document.getElementById('banUserId');
    const banUserForm = document.getElementById('banUserForm');

    banModal.addEventListener('show.bs.modal', function (event) {
      // Get the button that triggered the modal
      const button = event.relatedTarget;

      // Extract user details from data-* attributes
      const userName = button.getAttribute('data-user-name');
      const userId = button.getAttribute('data-user-id');

      // Update the modal content
      banUserName.textContent = userName;
      banUserId.value = userId;

      // Update the form action dynamically
      banUserForm.action = `/admin/ban_user/${userId}`; // Adjust the route as needed
    });

    const unbanModal = document.getElementById('unbanConfirmationModal');
    const unbanUserName = document.getElementById('unbanUserName');
    const unbanUserId = document.getElementById('unbanUserId');
    const unbanUserForm = document.getElementById('unbanUserForm');

    unbanModal.addEventListener('show.bs.modal', function (event) {
      // Get the button that triggered the modal
      const button = event.relatedTarget;

      // Extract user details from data-* attributes
      const userName = button.getAttribute('data-user-name');
      const userId = button.getAttribute('data-user-id');

      // Update the modal content
      unbanUserName.textContent = userName;
      unbanUserId.value = userId;

      // Set the form action dynamically to the unban route
      unbanUserForm.action = `/admin/unban_user/${userId}`;  // Adjust the route as needed
    });
  });
</script>


{% endblock %}