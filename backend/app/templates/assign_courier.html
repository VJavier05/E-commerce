{% extends "dashboard_1.html" %}
{% block content %}
<div id="flashMessage" class="alert alert-warning" role="alert" style="display: none;"></div>

<div class="d-flex justify-content-between align-items-center py-3 mb-2">
    <h4 class="fw-bold mb-0">
        <span class="text-muted fw-light">Courier /</span> Assign Couriers
    </h4>
    <a href="#" class="btn btn-primary" onclick="showCourierModal()">
        <i class="bi bi-truck-flatbed pe-md-2 pe-1"></i> Pickup Item
    </a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="input-group input-group-merge mb-3 search-input">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
                type="text"
                class="form-control"
                placeholder="Search Couriers..."
                aria-label="Search..."
                id="searchProduct"
                onkeyup="searchTable('assignCourierTable', 'searchProduct')"  
            />
        </div>

        <table class="table table-hover" id="assignCourierTable">
            <thead class="table-dark">
                <tr>
                    <th></th>
                    <th>Order ID</th>
                    <th>Customer Name</th>
                    <th>Address</th>
                    <th>Contact</th>
                    <th>Order Details</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for order in assignable_orders %}
                    <tr>
                        <td>
                            <div class="form-check">
                                <input 
                                    class="form-check-input order-checkbox" 
                                    type="checkbox" 
                                    name="selected_orders" 
                                    value="{{ order.id }}" 
                                    id="checkbox-{{ order.id }}"
                                >
                                <label class="form-check-label" for="checkbox-{{ order.id }}"></label>
                            </div>
                        </td>
                        <td>Order #{{ order.id }}</td>
                        <td>{{ order.user.first_name }} {{ order.user.last_name }}</td>
                        <td>
                            {% if order.address %}
                                {{ order.address.street }},
                                {{ order.address.barangay }},

                                {{ order.address.city }},
                                {{ order.address.province }}
                                ({{ order.address.postal_code }})
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>{{ order.address.telephone_no or 'N/A' }}</td>
                        <td>
                            {% for item in order.order_items %}
                                {% if item.status != 'Cancelled' %}
                                    <p>{{ item.product.name }} (x{{ item.quantity }})</p>
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% set non_cancelled_status = order.order_items | selectattr("status", "ne", "Cancelled") | map(attribute="status") | first %}

                            {% if non_cancelled_status %}
                                <span class="badge text-bg-info">{{ non_cancelled_status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="courierModal" tabindex="-1" role="dialog" aria-labelledby="courierModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="ViewCourierModalLabel">Courier Information</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="orderSummary" class="mb-3">
                    <!-- Selected order details will be populated here -->
                </div>
                <form id="assignCourierForm" action="{{ url_for('assign_courier') }}" method="POST">
                    <input type="hidden" name="order_ids" id="selectedOrderIds">
                    
                    <label for="courierSelect">Select Courier</label>
                    <select id="courierSelect" name="courier_id" class="form-control">
                        {% for courier in available_couriers %}
                            <option value="{{ courier.id }}">{{ courier.user.first_name }} {{ courier.user.last_name }} ( {{ courier.city }},{{ courier.province }} )</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="assignCourierForm" class="btn btn-primary">Assign Courier</button>
            </div>
        </div>
    </div>
</div>

<script>
function showCourierModal() {
    const selectedOrders = [];
    const orderDetails = [];
    document.querySelectorAll('.order-checkbox:checked').forEach((checkbox) => {
        selectedOrders.push(checkbox.value);
        // Add any additional information to the orderDetails array if needed
        const orderRow = checkbox.closest('tr'); // Find the closest row (tr)
        const orderId = checkbox.value;
        const customerName = orderRow.cells[2].textContent; // Assuming customer name is in the third column
        orderDetails.push(`Order ID: ${orderId}, Customer: ${customerName}`);
    });

    if (selectedOrders.length > 0) {
        document.getElementById('selectedOrderIds').value = selectedOrders.join(',');

        // Populate order summary in the modal
        const orderSummary = document.getElementById('orderSummary');
        orderSummary.innerHTML = orderDetails.join('<br>'); // Display each order detail on a new line

        // Show the modal here
        $('#courierModal').modal('show');
    } else {
        // Display a flash-style message
        const flashMessage = document.getElementById('flashMessage');
        flashMessage.textContent = "Please select at least one order to assign a courier.";
        flashMessage.classList.add('alert-warning');
        flashMessage.style.display = 'block';
        
        // Hide the message after 3 seconds
        setTimeout(() => {
            flashMessage.style.display = 'none';
        }, 3000);
    }
}
</script>

{% endblock %}
